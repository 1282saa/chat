"""
ì„œìš¸ê²½ì œì‹ ë¬¸ AI ìš”ì•½ ì‹œìŠ¤í…œ - WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° 
ê³µí†µ ë¡œì§ì€ core_processor.pyë¡œ ë¶„ë¦¬í•˜ì—¬ ì¤‘ë³µ ì œê±°
ì‹¤ì‹œê°„ í”¼ë“œë°±ê³¼ ìƒíƒœ ë©”ì‹œì§€ë¥¼ í†µí•œ ìµœì ì˜ ì‚¬ìš©ì ê²½í—˜ ì œê³µ
"""

import json
import boto3
import os
import logging
import traceback
from datetime import datetime
import sys
from pathlib import Path

# ê³µí†µ ì²˜ë¦¬ ëª¨ë“ˆ import
sys.path.append(str(Path(__file__).parent.parent / 'generate'))
sys.path.append(str(Path(__file__).parent.parent / 'utils'))

try:
    from core_processor import get_news_processor
    from common_utils import DecimalEncoder
except ImportError as e:
    print(f"ëª¨ë“ˆ import ì˜¤ë¥˜: {e}")

# ë¡œê¹… ì„¤ì •
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# AWS í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
bedrock_runtime = boto3.client(
    service_name='bedrock-runtime',
    region_name=os.environ.get('AWS_REGION', 'us-east-1')
)

apigateway = boto3.client('apigatewaymanagementapi',
    endpoint_url=f"https://{os.environ.get('API_GATEWAY_DOMAIN')}/{os.environ.get('STAGE', 'prod')}"
)

# í™˜ê²½ ë³€ìˆ˜
MODEL_ID = "anthropic.claude-3-sonnet-20240229-v1:0"

def lambda_handler(event, context):
    """WebSocket ë©”ì‹œì§€ ì²˜ë¦¬"""
    try:
        connection_id = event['requestContext']['connectionId']
        
        if event['requestContext']['eventType'] == 'MESSAGE':
            body = json.loads(event.get('body', '{}'))
            action = body.get('action')
            
            if action == 'stream':
                return handle_stream_request(connection_id, body)
            else:
                return send_error(connection_id, "ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•¡ì…˜ì…ë‹ˆë‹¤.")
        
        return {'statusCode': 200}
        
    except Exception as e:
        logger.error(f"âŒ WebSocket í•¸ë“¤ëŸ¬ ì˜¤ë¥˜: {str(e)}")
        logger.error(f"âŒ Traceback: {traceback.format_exc()}")
        return {'statusCode': 500}

def handle_stream_request(connection_id, data):
    """ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì²˜ë¦¬ - ê³µí†µ ë¡œì§ í™œìš©"""
    try:
        # ìš”ì²­ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        user_id = data.get('userSub') or data.get('projectId') or "default"
        user_input = data.get('userInput', '').strip()
        chat_history = data.get('chat_history', [])
        model_id = data.get('modelId', MODEL_ID)
        
        logger.info(f"ğŸŒŠ WebSocket ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼: user_id={user_id}, input={user_input[:50]}...")
        
        if not user_input:
            return send_error(connection_id, "ì‚¬ìš©ì ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        
        # ê³µí†µ ì²˜ë¦¬ ì—”ì§„ ì´ˆê¸°í™”
        news_processor = get_news_processor()
        
        # ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° í”Œë¡œìš° ì‹¤í–‰
        return execute_realtime_streaming_flow(connection_id, news_processor, user_input, chat_history, model_id)
        
    except Exception as e:
        logger.error(f"âŒ ìŠ¤íŠ¸ë¦¼ ìš”ì²­ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        return send_error(connection_id, f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

def execute_realtime_streaming_flow(connection_id, news_processor, user_input, chat_history, model_id):
    """ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° í”Œë¡œìš° ì‹¤í–‰ - ìƒíƒœ ë©”ì‹œì§€ì™€ í•¨ê»˜"""
    try:
        # ğŸš€ ìƒíƒœ 1: ì‹œì‘
        send_status_message(connection_id, "processing", "ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
        
        # ğŸ“… 1ë‹¨ê³„: ë‚ ì§œ ì •ì˜ ë° ì§ˆë¬¸ ë³´ê°•
        enhanced_query = news_processor.enhance_query_with_date(user_input)
        logger.info(f"ğŸ“… ë‚ ì§œ ë³´ê°•ëœ ì§ˆë¬¸: {enhanced_query}")
        
        # ğŸ” ìƒíƒœ 2: ê²€ìƒ‰ ì‹œì‘
        send_status_message(connection_id, "searching", "ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
        
        # ğŸ“° 2ë‹¨ê³„: AWS ë‚´ë¶€ ì§€ì‹ ê²€ìƒ‰ (ìµœì‹ ìˆœ)
        knowledge_context = news_processor.search_knowledge_base(enhanced_query)
        
        # ğŸŒ 3ë‹¨ê³„: í•„ìš”ì‹œ Perplexity APIë¡œ ë³´ê°•
        if news_processor.should_use_external_search(knowledge_context, user_input):
            send_status_message(connection_id, "external_searching", "ìµœì‹  ì •ë³´ë¥¼ ì¶”ê°€ë¡œ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
            
            external_context = news_processor.search_external_knowledge(enhanced_query)
            knowledge_context += f"\n\n[ì™¸ë¶€ ê²€ìƒ‰ ê²°ê³¼]\n{external_context}"
        
        # ğŸ’­ ìƒíƒœ 3: ë‹µë³€ ìƒì„± ì‹œì‘
        send_status_message(connection_id, "generating", "ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...")
        
        # ğŸ“ 4ë‹¨ê³„: ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        final_prompt = news_processor.build_final_prompt(user_input, chat_history, knowledge_context)
        
        # ğŸ¨ 5ë‹¨ê³„: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ìƒì„±
        stream_bedrock_response_realtime(connection_id, final_prompt, model_id)
        
        # âœ… ì™„ë£Œ ë©”ì‹œì§€ ì „ì†¡
        send_status_message(connection_id, "completed", "ë‹µë³€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        
        return {'statusCode': 200}
        
    except Exception as e:
        logger.error(f"âŒ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° í”Œë¡œìš° ì˜¤ë¥˜: {e}")
        return send_error(connection_id, f"ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

def stream_bedrock_response_realtime(connection_id, prompt, model_id):
    """ì‹¤ì‹œê°„ Bedrock ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ - WebSocketìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡"""
    try:
        # Claude 3 Sonnetìš© ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ êµ¬ì„±
        request_body = {
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 4000,
            "temperature": 0.1,
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        }
        
        # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
        response = bedrock_runtime.invoke_model_with_response_stream(
            modelId=model_id,
            contentType='application/json',
            accept='application/json',
            body=json.dumps(request_body)
        )
        
        # ğŸ”¥ ì‹¤ì‹œê°„ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì— ìŠ¤íŠ¸ë¦¬ë° ì „ì†¡
        full_response = ""
        for event in response['body']:
            chunk = json.loads(event['chunk']['bytes'])
            if chunk['type'] == 'content_block_delta':
                text = chunk['delta'].get('text', '')
                if text:
                    full_response += text
                    # âš¡ ì¦‰ì‹œ ì‹¤ì‹œê°„ ì²­í¬ ì „ì†¡
                    send_stream_chunk(connection_id, text, is_partial=True)
        
        # ğŸ“„ ì™„ë£Œëœ ì „ì²´ ì‘ë‹µ ì „ì†¡
        send_stream_chunk(connection_id, full_response, is_partial=False, is_complete=True)
        
        logger.info(f"âœ… ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì™„ë£Œ: {len(full_response)}ì")
        
    except Exception as e:
        logger.error(f"âŒ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì˜¤ë¥˜: {e}")
        send_error(connection_id, f"ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

def send_status_message(connection_id, status, message):
    """ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡ - ì‚¬ìš©ìì—ê²Œ ì§„í–‰ ìƒí™© í”¼ë“œë°±"""
    try:
        status_message = {
            "type": "status",
            "status": status,
            "message": message,
            "timestamp": datetime.now().isoformat()
        }
        send_message(connection_id, status_message)
        logger.info(f"ğŸ“¤ ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡: {status} - {message}")
    except Exception as e:
        logger.error(f"âŒ ìƒíƒœ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: {e}")

def send_stream_chunk(connection_id, content, is_partial=True, is_complete=False):
    """ìŠ¤íŠ¸ë¦¬ë° ì²­í¬ ì „ì†¡ - ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì „ì†¡"""
    try:
        chunk_message = {
            "type": "stream",
            "content": content,
            "isPartial": is_partial,
            "isComplete": is_complete,
            "timestamp": datetime.now().isoformat()
        }
        send_message(connection_id, chunk_message)
    except Exception as e:
        logger.error(f"âŒ ìŠ¤íŠ¸ë¦¼ ì²­í¬ ì „ì†¡ ì˜¤ë¥˜: {e}")

def send_message(connection_id, message):
    """WebSocket ë©”ì‹œì§€ ì „ì†¡"""
    try:
        apigateway.post_to_connection(
            ConnectionId=connection_id,
            Data=json.dumps(message, ensure_ascii=False)
        )
    except Exception as e:
        logger.error(f"âŒ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: {e}")

def send_error(connection_id, error_message):
    """ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡"""
    try:
        error_msg = {
            "type": "error",
            "error": error_message,
            "timestamp": datetime.now().isoformat()
        }
        send_message(connection_id, error_msg)
        return {'statusCode': 200}
    except Exception as e:
        logger.error(f"âŒ ì—ëŸ¬ ì „ì†¡ ì‹¤íŒ¨: {e}")
        return {'statusCode': 500}