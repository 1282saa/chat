{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useCallback } from \"react\";\nimport { toast } from \"react-hot-toast\";\nimport { generateAPI } from \"../services/api\";\n\n/**\n * 제목 생성 실행 및 결과 폴링을 위한 커스텀 훅\n * @param {string} projectId - 프로젝트 ID\n * @returns {Object} - 제목 생성 관련 상태와 함수들\n */\nexport const useOrchestration = projectId => {\n  _s();\n  const [isExecuting, setIsExecuting] = useState(false);\n  const [currentExecution, setCurrentExecution] = useState(null);\n  const [executionStatus, setExecutionStatus] = useState(null);\n  const [isStreaming, setIsStreaming] = useState(false);\n\n  /**\n   * 제목 생성 실행\n   * @param {string} userInput - 사용자 입력\n   * @param {Object} options - 추가 옵션 (예: chat_history, useStreaming)\n   * @returns {Promise<Object>} - 생성 결과\n   */\n  const executeOrchestration = useCallback(async (userInput, options = {}) => {\n    if (!userInput.trim()) {\n      toast.error(\"메시지를 입력해주세요.\");\n      return null;\n    }\n    try {\n      setIsExecuting(true);\n      setExecutionStatus(\"STARTING\");\n\n      // chat_history와 userInput을 포함하는 data 객체 생성\n      const data = {\n        userInput: userInput,\n        chat_history: options.chat_history || []\n      };\n      console.log(\"🚀 대화 생성 요청 시작:\", {\n        projectId,\n        inputLength: userInput.length,\n        historyLength: data.chat_history.length,\n        useStreaming: options.useStreaming === true,\n        timestamp: new Date().toISOString()\n      });\n\n      // 스트리밍 사용 여부 확인\n      if (options.useStreaming === true) {\n        setIsStreaming(true);\n\n        // 스트리밍 콜백 함수 설정\n        const onChunk = options.onChunk || (() => {});\n        const onError = error => {\n          setIsExecuting(false);\n          setIsStreaming(false);\n          setExecutionStatus(\"FAILED\");\n          if (options.onError) options.onError(error);\n        };\n        const onComplete = response => {\n          setIsExecuting(false);\n          setIsStreaming(false);\n          setExecutionStatus(\"COMPLETED\");\n          if (options.onComplete) options.onComplete(response);\n        };\n\n        // 스트리밍 API 호출\n        return await generateAPI.generateTitleStream(projectId, data, onChunk, onError, onComplete);\n      }\n\n      // 일반 API 호출 (스트리밍 미사용)\n      const response = await generateAPI.generateTitle(projectId, data);\n      console.log(\"✅ 대화 생성 완료:\", {\n        mode: response.mode,\n        message: response.message,\n        timestamp: new Date().toISOString()\n      });\n      setIsExecuting(false);\n      setExecutionStatus(\"COMPLETED\");\n      return response;\n    } catch (error) {\n      var _error$response, _error$response2, _error$response3, _error$response3$data;\n      console.error(\"❌ 제목 생성 실패:\", {\n        error: error.message,\n        code: error.code,\n        status: (_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status,\n        timestamp: new Date().toISOString()\n      });\n      setIsExecuting(false);\n      setIsStreaming(false);\n      setExecutionStatus(\"FAILED\");\n\n      // 프롬프트 카드 관련 에러 처리\n      if (((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.status) === 400 && (_error$response3 = error.response) !== null && _error$response3 !== void 0 && (_error$response3$data = _error$response3.data) !== null && _error$response3$data !== void 0 && _error$response3$data.setup_required) {\n        toast.error(\"프롬프트 카드를 먼저 설정해주세요!\");\n      } else if (error.code === \"ECONNABORTED\") {\n        toast.error(\"요청 시간이 초과되었습니다. 다시 시도해주세요.\");\n      } else {\n        toast.error(\"처리 중 오류가 발생했습니다.\");\n      }\n      throw error;\n    }\n  }, [projectId]);\n\n  /**\n   * 실행 상태 조회 (Step Functions 사용 시)\n   * @param {string} executionArn - 실행 ARN\n   * @param {Function} onComplete - 완료 시 콜백\n   * @param {Function} onError - 에러 시 콜백\n   */\n  const pollOrchestrationResult = useCallback(async (executionArn, onComplete, onError) => {\n    // 스트리밍 모드에서는 폴링이 필요 없음\n    if (isStreaming) {\n      return;\n    }\n    const poll = async () => {\n      try {\n        const result = await generateAPI.getExecutionStatus(executionArn);\n        setExecutionStatus(result.status);\n        if (result.status === \"SUCCEEDED\") {\n          setIsExecuting(false);\n          setExecutionStatus(\"COMPLETED\");\n          if (onComplete) {\n            onComplete(result);\n          }\n        } else if (result.status === \"FAILED\") {\n          setIsExecuting(false);\n          setExecutionStatus(\"FAILED\");\n          if (onError) {\n            onError(new Error(\"처리 실패\"));\n          }\n        } else if (result.status === \"RUNNING\") {\n          // 3초 후 다시 폴링\n          setTimeout(poll, 3000);\n        }\n      } catch (error) {\n        console.error(\"실행 상태 조회 실패:\", error);\n        setIsExecuting(false);\n        setExecutionStatus(\"FAILED\");\n        if (onError) {\n          onError(error);\n        }\n      }\n    };\n    poll();\n  }, [projectId, isStreaming]);\n\n  /**\n   * 오케스트레이션 상태 초기화\n   */\n  const resetOrchestration = useCallback(() => {\n    setIsExecuting(false);\n    setIsStreaming(false);\n    setCurrentExecution(null);\n    setExecutionStatus(null);\n  }, []);\n  return {\n    isExecuting,\n    isStreaming,\n    currentExecution,\n    executionStatus,\n    executeOrchestration,\n    pollOrchestrationResult,\n    resetOrchestration\n  };\n};\n_s(useOrchestration, \"dycC0VGflW0bdLmxCDlLdpde9RQ=\");","map":{"version":3,"names":["useState","useCallback","toast","generateAPI","useOrchestration","projectId","_s","isExecuting","setIsExecuting","currentExecution","setCurrentExecution","executionStatus","setExecutionStatus","isStreaming","setIsStreaming","executeOrchestration","userInput","options","trim","error","data","chat_history","console","log","inputLength","length","historyLength","useStreaming","timestamp","Date","toISOString","onChunk","onError","onComplete","response","generateTitleStream","generateTitle","mode","message","_error$response","_error$response2","_error$response3","_error$response3$data","code","status","setup_required","pollOrchestrationResult","executionArn","poll","result","getExecutionStatus","Error","setTimeout","resetOrchestration"],"sources":["/Users/yeong-gwang/Documents/work/서울경제신문/ai_제목달기(수)_완성본_스트리밍구현 복사본/frontend/src/hooks/useOrchestration.js"],"sourcesContent":["import { useState, useCallback } from \"react\";\nimport { toast } from \"react-hot-toast\";\nimport { generateAPI } from \"../services/api\";\n\n/**\n * 제목 생성 실행 및 결과 폴링을 위한 커스텀 훅\n * @param {string} projectId - 프로젝트 ID\n * @returns {Object} - 제목 생성 관련 상태와 함수들\n */\nexport const useOrchestration = (projectId) => {\n  const [isExecuting, setIsExecuting] = useState(false);\n  const [currentExecution, setCurrentExecution] = useState(null);\n  const [executionStatus, setExecutionStatus] = useState(null);\n  const [isStreaming, setIsStreaming] = useState(false);\n\n  /**\n   * 제목 생성 실행\n   * @param {string} userInput - 사용자 입력\n   * @param {Object} options - 추가 옵션 (예: chat_history, useStreaming)\n   * @returns {Promise<Object>} - 생성 결과\n   */\n  const executeOrchestration = useCallback(\n    async (userInput, options = {}) => {\n      if (!userInput.trim()) {\n        toast.error(\"메시지를 입력해주세요.\");\n        return null;\n      }\n\n      try {\n        setIsExecuting(true);\n        setExecutionStatus(\"STARTING\");\n\n        // chat_history와 userInput을 포함하는 data 객체 생성\n        const data = {\n          userInput: userInput,\n          chat_history: options.chat_history || [],\n        };\n\n        console.log(\"🚀 대화 생성 요청 시작:\", {\n          projectId,\n          inputLength: userInput.length,\n          historyLength: data.chat_history.length,\n          useStreaming: options.useStreaming === true,\n          timestamp: new Date().toISOString(),\n        });\n\n        // 스트리밍 사용 여부 확인\n        if (options.useStreaming === true) {\n          setIsStreaming(true);\n\n          // 스트리밍 콜백 함수 설정\n          const onChunk = options.onChunk || (() => {});\n          const onError = (error) => {\n            setIsExecuting(false);\n            setIsStreaming(false);\n            setExecutionStatus(\"FAILED\");\n            if (options.onError) options.onError(error);\n          };\n          const onComplete = (response) => {\n            setIsExecuting(false);\n            setIsStreaming(false);\n            setExecutionStatus(\"COMPLETED\");\n            if (options.onComplete) options.onComplete(response);\n          };\n\n          // 스트리밍 API 호출\n          return await generateAPI.generateTitleStream(\n            projectId,\n            data,\n            onChunk,\n            onError,\n            onComplete\n          );\n        }\n\n        // 일반 API 호출 (스트리밍 미사용)\n        const response = await generateAPI.generateTitle(projectId, data);\n\n        console.log(\"✅ 대화 생성 완료:\", {\n          mode: response.mode,\n          message: response.message,\n          timestamp: new Date().toISOString(),\n        });\n\n        setIsExecuting(false);\n        setExecutionStatus(\"COMPLETED\");\n\n        return response;\n      } catch (error) {\n        console.error(\"❌ 제목 생성 실패:\", {\n          error: error.message,\n          code: error.code,\n          status: error.response?.status,\n          timestamp: new Date().toISOString(),\n        });\n        setIsExecuting(false);\n        setIsStreaming(false);\n        setExecutionStatus(\"FAILED\");\n\n        // 프롬프트 카드 관련 에러 처리\n        if (\n          error.response?.status === 400 &&\n          error.response?.data?.setup_required\n        ) {\n          toast.error(\"프롬프트 카드를 먼저 설정해주세요!\");\n        } else if (error.code === \"ECONNABORTED\") {\n          toast.error(\"요청 시간이 초과되었습니다. 다시 시도해주세요.\");\n        } else {\n          toast.error(\"처리 중 오류가 발생했습니다.\");\n        }\n\n        throw error;\n      }\n    },\n    [projectId]\n  );\n\n  /**\n   * 실행 상태 조회 (Step Functions 사용 시)\n   * @param {string} executionArn - 실행 ARN\n   * @param {Function} onComplete - 완료 시 콜백\n   * @param {Function} onError - 에러 시 콜백\n   */\n  const pollOrchestrationResult = useCallback(\n    async (executionArn, onComplete, onError) => {\n      // 스트리밍 모드에서는 폴링이 필요 없음\n      if (isStreaming) {\n        return;\n      }\n\n      const poll = async () => {\n        try {\n          const result = await generateAPI.getExecutionStatus(executionArn);\n\n          setExecutionStatus(result.status);\n\n          if (result.status === \"SUCCEEDED\") {\n            setIsExecuting(false);\n            setExecutionStatus(\"COMPLETED\");\n\n            if (onComplete) {\n              onComplete(result);\n            }\n          } else if (result.status === \"FAILED\") {\n            setIsExecuting(false);\n            setExecutionStatus(\"FAILED\");\n\n            if (onError) {\n              onError(new Error(\"처리 실패\"));\n            }\n          } else if (result.status === \"RUNNING\") {\n            // 3초 후 다시 폴링\n            setTimeout(poll, 3000);\n          }\n        } catch (error) {\n          console.error(\"실행 상태 조회 실패:\", error);\n          setIsExecuting(false);\n          setExecutionStatus(\"FAILED\");\n\n          if (onError) {\n            onError(error);\n          }\n        }\n      };\n\n      poll();\n    },\n    [projectId, isStreaming]\n  );\n\n  /**\n   * 오케스트레이션 상태 초기화\n   */\n  const resetOrchestration = useCallback(() => {\n    setIsExecuting(false);\n    setIsStreaming(false);\n    setCurrentExecution(null);\n    setExecutionStatus(null);\n  }, []);\n\n  return {\n    isExecuting,\n    isStreaming,\n    currentExecution,\n    executionStatus,\n    executeOrchestration,\n    pollOrchestrationResult,\n    resetOrchestration,\n  };\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}